<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SPX102 Coach Ross</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <!-- Tailwind CSS for modern styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      font-family: 'Open Sans', sans-serif;
      --color-primary: #0052C4;
      --color-secondary: #fce726;
      --color-surface: #ffffff;
      --color-muted: #f8fafc;
      --color-border: #e2e8f0;
      --color-text: #0f172a;
      --color-subtle: #475569;
    }
    
    /* Custom Scrollbar */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    
    .custom-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scroll::-webkit-scrollbar-track {
      background: rgba(226, 232, 240, 0.8);
    }
    .custom-scroll::-webkit-scrollbar-thumb {
      background-color: #94a3b8;
      border-radius: 20px;
    }

    /* Message Bubbles */
    .msg-user {
      border-radius: 18px 18px 4px 18px;
    }
    .msg-bot {
      border-radius: 18px 18px 18px 4px;
    }

    .msg-user,
    .msg-bot,
    .rich-text {
      word-break: break-word;
      overflow-wrap: anywhere;
      hyphens: auto;
      max-width: 100%;
    }

    /* Bounce animation for dots */
    .typing-dot {
      animation: bounce 1.4s infinite ease-in-out both;
      background-color: #94a3b8; 
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin: 0 2px;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* Gradient Text */
    .text-gradient {
      background: linear-gradient(to right, #0052C4, #1a73e8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Rich text styling for bot replies */
    .rich-text {
      color: var(--color-text);
    }
    .rich-text h2,
    .rich-text h3,
    .rich-text h4 {
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--color-primary);
      margin-bottom: 0.35rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    .rich-text h2::before,
    .rich-text h3::before,
    .rich-text h4::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 9999px;
      background: linear-gradient(135deg, #0052C4, #1a73e8);
      box-shadow: 0 0 0 6px rgba(0, 82, 196, 0.08);
    }
    .rich-text p {
      margin-bottom: 0.75rem;
      line-height: 1.7;
    }
    .rich-text ul {
      list-style: none;
      padding-left: 0;
      margin: 0.5rem 0 1rem;
      display: grid;
      gap: 0.35rem;
    }
    .rich-text ul li {
      position: relative;
      padding-left: 1.2rem;
    }
    .rich-text ul li::before {
      content: "•";
      position: absolute;
      left: 0;
      top: 0;
      color: var(--color-primary);
      font-weight: 700;
    }
    .rich-text ol {
      counter-reset: item;
      padding-left: 0;
      margin: 0.5rem 0 1rem;
      display: grid;
      gap: 0.35rem;
    }
    .rich-text ol li {
      counter-increment: item;
      padding-left: 1.6rem;
      position: relative;
    }
    .rich-text ol li::before {
      content: counter(item) ".";
      position: absolute;
      left: 0;
      top: 0;
      color: var(--color-primary);
      font-weight: 700;
    }
    .rich-text hr {
      border: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(148, 163, 184, 0.4), transparent);
      margin: 1.5rem 0;
    }
    .rich-text table {
      width: 100%;
      max-width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 12px;
      overflow: hidden;
      background: #f8fafc;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .rich-text th,
    .rich-text td {
      padding: 0.65rem 0.9rem;
      text-align: left;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
    }
    .rich-text th {
      background: linear-gradient(90deg, rgba(0, 82, 196, 0.12), rgba(26, 115, 232, 0.08));
      color: #0f172a;
      font-weight: 700;
      letter-spacing: 0.01em;
      text-transform: uppercase;
      font-size: 0.75rem;
    }
    .rich-text tr:last-child td {
      border-bottom: none;
    }
    .rich-text strong {
      color: #0f172a;
      font-weight: 700;
    }
    .rich-text .card-block {
      background: linear-gradient(145deg, rgba(0, 82, 196, 0.06), rgba(240, 247, 255, 0.9));
      border: 1px solid rgba(0, 82, 196, 0.25);
      padding: 1rem;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0, 82, 196, 0.08);
      backdrop-filter: blur(6px);
      margin-bottom: 0.9rem;
    }
  </style>
</head>
<body class="bg-white text-slate-900 h-screen flex flex-col overflow-hidden selection:bg-[#0052C4] selection:text-white">

  <!-- Header -->
  <header class="flex-none bg-white backdrop-blur-md border-b border-slate-200 p-4 flex items-center gap-4 z-20 shadow-sm">
    <div class="relative group cursor-pointer">
      <div class="absolute -inset-0.5 bg-gradient-to-r from-[#0052C4] to-[#1a73e8] rounded-full blur opacity-40 group-hover:opacity-80 transition duration-500"></div>
      <img
        src="./ross pic.png"
        alt="Ross Clark"
        class="relative w-12 h-12 rounded-full object-cover border-2 border-white"
        onerror="this.src='https://ui-avatars.com/api/?name=Ross+Clark&background=6366f1&color=fff'"
      />
      <div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full animate-pulse"></div>
    </div>
    
    <div class="flex-1 min-w-0">
      <h1 class="text-lg font-semibold text-slate-900 truncate flex items-center gap-2">
        Dr. Ross Clark
        <span class="px-2 py-0.5 rounded-full bg-[#0052C4]/10 text-[#0052C4] text-xs font-medium border border-[#0052C4]/20">AI Coach</span>
      </h1>
      <p class="text-xs text-slate-500 truncate">SPX102 Introduction to Coaching • Always Online</p>
    </div>
    
    <!-- Info Button -->
    <button onclick="alert('I can only answer questions based on the SPX102 Notes.')" class="p-2 text-slate-500 hover:text-slate-900 transition-colors rounded-full hover:bg-slate-100">
      <i data-lucide="info" class="w-5 h-5"></i>
    </button>
  </header>

  <!-- Chat Log -->
  <main id="chat-log" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-6 scroll-smooth bg-white">

    <!-- Focus Toggles -->
    <section class="bg-slate-50 border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
      <p class="text-sm text-slate-700">Select none, one or both to make the chatbot focus on sports, clinical or sports-related clinical examples</p>
      <div class="flex flex-wrap gap-3">
        <button id="clinical-toggle" type="button" class="focus:outline-none relative overflow-hidden rounded-xl border border-slate-200 bg-white transition hover:-translate-y-0.5 hover:border-[#0052C4]/70 active:scale-[0.99] p-2 shadow-sm">
          <img src="./clinical.png" alt="Clinical focus" class="w-24 h-24 object-cover rounded-lg" />
          <span class="sr-only">Toggle clinical focus</span>
        </button>
        <button id="sports-toggle" type="button" class="focus:outline-none relative overflow-hidden rounded-xl border border-slate-200 bg-white transition hover:-translate-y-0.5 hover:border-[#0052C4]/70 active:scale-[0.99] p-2 shadow-sm">
          <img src="./sports.png" alt="Sports focus" class="w-24 h-24 object-cover rounded-lg" />
          <span class="sr-only">Toggle sports focus</span>
        </button>
      </div>
    </section>
    
    <!-- Welcome Message -->
    <div class="flex gap-4">
      <img src="./ross pic.png" class="w-10 h-10 rounded-full object-cover border border-slate-200 flex-none self-end mb-1" alt="Bot">
      <div class="space-y-1 max-w-[85%]">
        <div class="text-xs text-slate-500 ml-1">Ross Clark</div>
        <div class="msg-bot bg-white border border-slate-200 p-4 text-sm leading-relaxed shadow-sm text-slate-800">
          <p>Hello! I'm your AI assistant for <span class="text-[#0052C4] font-semibold">SPX102 INTRODUCTION TO COACHING</span>.</p>
          <br>
          <p>I can help you understand coaching pedagogy, training principles, or LTAD based on our course notes. What's on your mind?</p>
        </div>
      </div>
    </div>

  </main>

  <!-- Typing Indicator (Hidden by default) -->
  <div id="typing-indicator" class="hidden px-4 pb-2">
    <div class="flex gap-4">
      <img src="./ross pic.png" class="w-8 h-8 rounded-full object-cover border border-slate-200 flex-none self-end opacity-70" alt="Bot">
      <div class="msg-bot bg-slate-100 border border-slate-200 p-3 rounded-2xl rounded-bl-none w-16 flex items-center justify-center h-10">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>
  </div>

  <!-- Input Area -->
  <footer class="flex-none p-4 bg-white backdrop-blur-lg border-t border-slate-200">
    <form id="chat-form" class="max-w-4xl mx-auto relative flex items-end gap-2">
      
      <div class="relative flex-1 bg-slate-50 border border-slate-200 rounded-2xl focus-within:ring-2 focus-within:ring-[#0052C4]/40 focus-within:border-[#0052C4] focus-within:bg-white transition-all duration-300 shadow-sm">
        <textarea
          id="user-input"
          rows="1"
          class="w-full bg-transparent text-slate-900 placeholder-slate-400 px-4 py-3.5 outline-none resize-none overflow-hidden max-h-32 text-sm"
          placeholder="Ask a question about coaching..."
          oninput="this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'"></textarea>
      </div>

      <button 
        type="submit" 
        id="send-btn" 
        class="flex-none h-[50px] w-[50px] bg-[#0052C4] hover:bg-[#1a73e8] text-white rounded-full flex items-center justify-center shadow-lg shadow-blue-500/30 transition-all hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
        <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
      </button>

    </form>
    <div class="text-center mt-2">
       <span id="error" class="text-xs text-red-400 font-medium"></span>
       <span class="text-[10px] text-slate-500">I can only answer questions based on the SPX102 INTRODUCTION TO COACHING notes I was given.</span>
    </div>
  </footer>

  <script>
    // Initialize Icons
    lucide.createIcons();

    const API_URL = "/.netlify/functions/openrouter-chat"; // Original Backend URL
    const chatLog = document.getElementById("chat-log");
    const form = document.getElementById("chat-form");
    const textarea = document.getElementById("user-input");
    const errorSpan = document.getElementById("error");
    const sendBtn = document.getElementById("send-btn");
    const typingIndicator = document.getElementById("typing-indicator");
    const clinicalToggle = document.getElementById("clinical-toggle");
    const sportsToggle = document.getElementById("sports-toggle");

    // Full message history
    let messages = [];
    let focusState = { clinical: false, sports: false };
    let pendingFocusInstruction = "";

    // --- KNOWLEDGE BASE (Restored) ---
    const knowledgeBase = `
## Section 1: Coaching Pedagogy and Methodology

**1.1 The Role of the Coach**
* **Primary Goal:** Enhance performance (executing a skill in a specific context) [1], [2].
* **Key Functions:** Teaching, facilitating practice, providing feedback, and acting as a guide/facilitator rather than just an explicit instructor [2], [3].
* **Modern vs. Old School:** Modern coaching focuses on athlete problem-solving and games-based approaches, whereas "old school" (20th century) focused on isolation drills and explicit instruction [3].
* **Frameworks:** Coaching must adjust for Specificity (training specific to the sport) and Individuality (adjusting for athlete needs) [4].

**1.2 Learning Modalities**
* **Visual:** Prefers graphs, diagrams, demonstrations [5].
* **Auditory:** Prefers listening to instructions [5].
* **Kinesthetic:** Prefers to learn by doing/feeling body positions [5].
* **Reader/Writer:** Prefers taking notes [5].
* **Multimodal:** Most learners prefer a combination of methods [5].

**1.3 The Learning Process Loop**
1.  **Instruction:** Verbal communication [6].
2.  **Practice/Execution:** Performing the skill [7].
3.  **Feedback/Reflection:** Reviewing performance [7].
4.  **Learning Effect:** Positive adaptation or maladaptation [7].
5.  **Retention:** Consolidating the skill [7].

**1.4 Instruction and Demonstration**
* **Verbal Tips:** Use short, simple keywords; avoid information overload; use a "Sandwich approach" for feedback (Positive-Constructive-Positive) [8]. Avoid pointing out "what not to do" [9].
* **Demonstration:** Must be performed correctly to avoid negative motor programs [9]. Show at normal speed first to demonstrate timing, then break down if needed [10].

**1.5 Feedback Types**
* **Task Intrinsic:** Sensory info available to the athlete naturally (visual, proprioceptive) [11].
* **Augmented:** Info provided by the coach [12].
    * **Knowledge of Results (KR):** Outcome (e.g., "Did it go in?") [12].
    * **Knowledge of Performance (KP):** Technical info (e.g., "Knee angle was wrong") [12].

**1.6 Games-Based Learning (GBL) & Session Design**
* **Dynamic Systems Theory:** Skills emerge from the interaction of Task, Performer, and Environment constraints [13].
* **Modification Frameworks:**
    * **TREE:** Teaching style, Rules, Environment, Equipment [14].
    * **CHANGE IT:** Coaching style, How to score, Area, Numbers, Game rules, Equipment, Inclusion, Time [14], [15].
* **Teaching Games for Understanding (TGfU):** Uses modified games to teach skills/tactics under pressure (e.g., 3v3 soccer on a small pitch) [15].
* **Technique Variability:** There is no single "perfect" technique; variability is normal. Only modify technique for injury prevention or clear performance enhancement [16], [17].

**1.7 Warm-Up Design**
* **Effectiveness:** Dynamic warm-ups improve sprint/jump performance by 7–8% [18].
* **Caution:** Static stretching can reduce max strength by ~30% for up to 20 minutes [19].
* **Team Sport Formula:** 1. Range of Motion (low load) -> 2. Dynamic component (3-5 min) -> 3. Skill warm-up -> 4. Small-sided game [19].

---

## Section 2: Officiating

**2.1 Role of the Official**
* **Definition:** Controls gameplay by applying laws/rules to ensure fair play [20].
* **Three Key Duties:** Control the game, Decision-making (fractions of a second), Communication (explaining decisions) [21].
* **Categories:**
    * **Interactors:** High physical/interaction demands (e.g., Soccer referee) [22].
    * **Monitors:** Low physical, high cue processing (e.g., Volleyball ref) [22].
    * **Reactors:** Low interaction/movement (e.g., Tennis line judge) [22].
* **Decision-Making Process:** Stimulus -> Perception -> Categorization -> Memory Access -> Integration -> Response [23], [24].

---

## Section 3: Talent Identification and Testing

**3.1 Types of Talent ID**
* **Talent Selection:** Choosing athletes already participating in the sport (e.g., draft combines) [25].
* **Talent Detection:** Recruiting athletes from outside the sport based on physical attributes (e.g., long legs for rowing) [25].

**3.2 Testing Principles**
* **Reliability:** Consistency of measurement (reproducibility) [26].
* **Validity:** Accuracy of measurement (measuring what it intends to measure) [27].

**3.3 Kinanthropometry**
* **Definition:** Measuring body segment lengths, girths, and ratios [28].
* **Peak Height Velocity (PHV):** The period of fastest growth during puberty; requires load management to prevent injury [29].
* **Bone Density:** Critical for preventing stress fractures; measured via DEXA [29].

---

## Section 4: Training Principles and Capacities

**4.1 Core Principles**
* **Overload:** Manipulating load to stimulate adaptation [30].
* **FIT:** Frequency, Intensity, Time/Duration, Type [30].
* **Specificity:** Adaptations are specific to the training mode [31].
* **Individuality:** Athletes adapt differently based on age, genetics, and history [31].
* **Reversibility:** "Use it or lose it" [31].
* **Super Compensation:** The cycle of fatigue followed by recovery and improved capacity [32].

**4.2 Training Capacities**
* **Endurance:** Ability to resist fatigue. Trained via long intervals, repeat sprints, or small-sided games (SSG) [33].
* **Strength:** Maximal force production. Types include Maximal, Relative (strength to weight ratio), and Strength Endurance [34].
* **Power:** Force x Velocity [35].
* **Speed:** Stride Length x Stride Frequency [36]. Trained via intervals, resistance training, and plyometrics [37].
* **Flexibility:** Range of motion (ROM). Females generally more flexible. Trained via Static (post-exercise) or Dynamic (pre-exercise) stretching [38], [39].
* **Skill:** Efficiency and consistency of movement. Expert performers have high movement economy and automated processing [40], [41].

---

## Section 5: Planning and Periodisation

**5.1 Planning Cycles**
* **Quadrennial:** 4-year plan (Olympic cycle). Can be Mono-cycle (one peak) or Bi-cycle (two peaks) [42].
* **Macrocycle:** Typically 1 year [43].
* **Mesocycle:** 4–6 weeks, focused on specific adaptations [43].
* **Microcycle:** 1 week (e.g., 1 peak session, recovery, match day) [43].

**5.2 Phases of Training**
1.  **General Preparatory:** High volume, moderate intensity (Aerobic/Strength base) [44].
2.  **Specific Preparatory:** Higher intensity, sport-specific conditioning [45].
3.  **Pre-Competition:** High intensity, low volume, tactical focus [45].
4.  **Competition:** Maintenance of fitness, peak performance [45].
5.  **Transition:** Active rest/recovery [46].

**5.3 Tapering**
* Reducing load before competition to reduce fatigue while maintaining fitness [47].
* **Best Practice:** Reduce volume, maintain intensity [47]. Can improve performance by 2–3% [48].

---

## Section 6: Long-Term Athlete Development (LTAD)

**6.1 The 7 Stages**
1.  **Active Start (0-6):** Fun, fundamental movements [49].
2.  **FUNdamentals (6-9/10):** Agility, balance, coordination. No specialization [49].
3.  **Learn to Train (8-11/12):** Sport-specific skills, motor learning window [49].
4.  **Train to Train (11-15/16):** Aerobic base, strength, PHV management [50], [51].
5.  **Train to Compete (15-21+):** Specialization, high intensity, sophisticated periodisation [50], [52].
6.  **Train to Win (18+):** Elite performance, winning focus, autonomous athletes [50], [53].
7.  **Active for Life:** Transition to recreational sport, coaching, or administration [54], [55].

**6.2 Youth Considerations (LTT & TTT)**
* **Injuries:**
    * *Osgood-Schlatter:* Knee pain (tibial tuberosity) [56].
    * *Sever’s Disease:* Heel pain (calcaneus) [56].
    * *Little Leaguer’s Elbow:* Medial epicondylitis from throwing [57].
* **Thermoregulation:** Children gain heat faster and sweat less; need breaks every 15–20 mins in heat [57].

**6.3 Active for Life Streams**
* **Competitive for Life:** Masters sports [55].
* **Fit for Life:** General health maintenance (combats obesity, osteoporosis) [55].
* **Sport Leaders:** Coaching/officiating roles [58].

---

## Section 7: Special Populations

**7.1 Female Athletes**
* **Classification (IOC):** Transgender female athletes previously required testosterone <10 nmol/L for 12 months (2015 rules), but 2021 framework shifts to sport-specific rules [59].
* **ACL Injury Risk:** Females are 2–8x more likely to suffer non-contact ACL injuries [60].
    * *Causes:* Wider pelvis (Q-angle), hormonal laxity (Relaxin), Quad dominance [61], [60].
    * *Prevention:* Land with hip/knee flexion, strengthen posterior chain (glutes/hamstrings) [62].
* **Menstrual Cycle:**
    * *Luteal Phase:* High body temp (heat risk), increased laxity (injury risk), bloating [63], [64].
    * *Triad:* Low Energy Availability -> Menstrual Dysfunction (Amenorrhea) -> Low Bone Density (Osteoporosis) [65].

**7.2 Aging Athletes**
* **Physiological Declines:** Reduced VO2 max (~30-40% drop), Sarcopenia (muscle loss ~3kg/decade), lower max heart rate, lower bone density [66], [67], [68].
* **Bone Health:** Osteoporosis risk increases. Cycling/Swimming do *not* help bone density. High-impact/resistance training is required [69], [70].
* **Training:** Requires longer recovery, thorough warm-ups, and pre-exercise screening (cardiac risk) [71], [72].

**7.3 Athletes with Disability**
* **Coaching:** Principles (progressive overload, periodisation) remain the same; modify for specific constraints [73].
* **Spinal Cord Injury (SCI):**
    * *Thermoregulation:* Impaired sweating below lesion (overheating risk) [74].
    * *Autonomic Dysreflexia:* Dangerous BP spike from pain stimulus [74].
* **Cerebral Palsy:** Characterized by Spasticity (hyperactive stretch reflex). Stretching is a priority [75], [76].
* **Sensory Impairment:**
    * *Vision:* Use guides, auditory balls [77].
    * *Hearing:* Use visual cues/sign language [78].

---

## Section 8: Future Trends and Technology

**8.1 Data Analytics**
* **Types:**
    * *Descriptive:* What happened? (e.g., GPS distance) [79].
    * *Diagnostic:* Why did it happen? [79].
    * *Predictive:* What will happen? (e.g., Brentford FC using "hops" metric to predict aerial wins) [79], [80].
    * *Prescriptive:* How do we make it happen? [79].
* **Process:** Collect -> Store/Clean -> Visualize -> Consult [81], [82].

**8.2 Artificial Intelligence (AI)**
* **Officiating:** Semi-automated offside tech (limb-tracking + smart ball) [83].
* **Programming:** AI apps (e.g., Coach Cat) automate plans but require human oversight for context (e.g., sleep quality vs. HRV) [84], [85].

**8.3 Super Shoes**
* **Technology:** Carbon fiber plate + large foam base [86].
* **Benefits:** Improve running economy by ~4% (approx. 2% faster time) [87].
* **Mechanism:** Carbon plate acts as a lever at the MTP joint and ankle to reduce energy loss [87].
* **Regulations:** Stack height must be ≤ 40mm; only one rigid plate allowed [88].
    `.trim();

    // --- SYSTEM PROMPT BUILDER (Restored) ---
    function buildSystemPrompt() {
      return `
Your role:
- You are the SPX102 INTRODUCTION TO COACHING course chatbot. Answer only from the provided notes.

You MUST follow these rules exactly:

1. PRIORITISE SAFETY OF THE USER
   - If the user appears to be in immediate danger, at risk of harming themselves, or describes serious harm from others:
     - Do NOT provide clinical advice.
     - Encourage them to seek urgent help.
     - Provide specific contacts such as:
       - Emergency services (e.g., call 000 in Australia).
       - National mental health helplines (e.g., Lifeline 13 11 14 in Australia).
       - Campus security and student support services (the teaching team will configure these for you).
   - Be warm, supportive, and non-judgemental.

2. ABSOLUTE SAFETY RESTRICTIONS
   - You must NEVER:
     - Provide instructions, methods, or encouragement for self-harm or suicide.
     - Provide guidance on illegal drugs, their manufacture, or their unsafe use.
     - Provide instructions for violence, weapons, or harming others.
   - If asked, clearly refuse and, where appropriate, gently steer the conversation to safety and wellbeing or back to course-related content.

3. STYLE
   - Use clear, concise explanations.
   - When explaining difficult concepts, use simple examples aimed at university educators.
   - When describing workflows, display the steps as a vertical list with emoji bullet points. Use bold headers for the action on each bullet, followed by details. Put "Tools" and "Why" on separate lines under the header.

KNOWLEDGE BASE (sole source of truth):
${knowledgeBase}
      `.trim();
    }

    // --- UI HELPER FUNCTIONS ---
    
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function applyInlineFormatting(text) {
      const cleaned = text.replace(/<br\s*\/?>/gi, " ");
      const escaped = escapeHtml(cleaned);
      const bolded = escaped.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
      return bolded.replace(/_(.*?)_/g, "<em>$1</em>");
    }

    function renderTable(lines, startIndex) {
      const rows = [];
      let i = startIndex;
      while (i < lines.length && lines[i].trim().startsWith("|")) {
        const row = lines[i]
          .trim()
          .replace(/^\||\|$/g, "")
          .split("|")
          .map((cell) => applyInlineFormatting(cell.trim()));
        rows.push(row);
        i++;
      }

      let header = [];
      let body = rows;

      if (rows.length > 1 && rows[1].every((cell) => /^-+$/.test(cell.replace(/<.*?>/g, "")))) {
        header = rows[0];
        body = rows.slice(2);
      }

      const headerHtml = header.length
        ? `<thead><tr>${header.map((cell) => `<th>${cell}</th>`).join("")}</tr></thead>`
        : "";
      const bodyHtml = body
        .map((row) => `<tr>${row.map((cell) => `<td>${cell}</td>`).join("")}</tr>`)
        .join("");

      return { html: `<table class="rich-text-table">${headerHtml}<tbody>${bodyHtml}</tbody></table>`, nextIndex: i - 1 };
    }

    function formatMessage(content) {
      const lines = content.trim().split("\n");
      let html = '<div class="rich-text space-y-2">';
      let inUl = false;
      let inOl = false;

      const closeLists = () => {
        if (inUl) {
          html += "</ul>";
          inUl = false;
        }
        if (inOl) {
          html += "</ol>";
          inOl = false;
        }
      };

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) {
          closeLists();
          continue;
        }

        // Tables
        if (line.startsWith("|")) {
          closeLists();
          const { html: tableHtml, nextIndex } = renderTable(lines, i);
          html += tableHtml;
          i = nextIndex;
          continue;
        }

        // Headings
        if (/^#{1,6}\s+/.test(line)) {
          closeLists();
          const level = line.match(/^#+/)[0].length;
          const text = applyInlineFormatting(line.replace(/^#{1,6}\s+/, ""));
          html += `<h${Math.min(level + 1, 4)}>${text}</h${Math.min(level + 1, 4)}>`;
          continue;
        }

        // Divider
        if (/^(-\s*){3,}$/.test(line)) {
          closeLists();
          html += "<hr/>";
          continue;
        }

        // Ordered List
        const orderedMatch = line.match(/^\d+\.\s+(.*)/);
        if (orderedMatch) {
          if (!inOl) {
            closeLists();
            inOl = true;
            html += '<ol class="pl-4">';
          }
          html += `<li>${applyInlineFormatting(orderedMatch[1])}</li>`;
          continue;
        }

        // Unordered List
        const unorderedMatch = line.match(/^[-*]\s+(.*)/);
        if (unorderedMatch) {
          if (!inUl) {
            closeLists();
            inUl = true;
            html += '<ul class="pl-4">';
          }
          html += `<li>${applyInlineFormatting(unorderedMatch[1])}</li>`;
          continue;
        }

        // Paragraph / Card block
        closeLists();
        const paragraph = applyInlineFormatting(line);
        const isEmphasized = paragraph.startsWith("<strong>") || paragraph.toLowerCase().startsWith("note:");
        html += `<div class="${isEmphasized ? "card-block" : ""}"><p>${paragraph}</p></div>`;
      }

      closeLists();
      html += "</div>";
      return html;
    }

    function setToggleState(button, isActive) {
      button.setAttribute("aria-pressed", isActive);
      const highlightClasses = [
        "ring-4",
        "ring-offset-2",
        "ring-offset-white",
        "ring-[var(--color-secondary)]",
        "border-[var(--color-secondary)]",
        "bg-[var(--color-secondary)]/20",
        "shadow-lg",
        "shadow-yellow-200/80",
      ];

      highlightClasses.forEach((cls) => button.classList.toggle(cls, isActive));
    }

    function updatePendingFocusInstruction() {
      const { clinical, sports } = focusState;
      if (clinical && sports) {
        pendingFocusInstruction = "use examples specific to sports related clinical exercise physiology";
      } else if (clinical) {
        pendingFocusInstruction = "use an example appropriate to clinical exercise physiology that is not sports related";
      } else if (sports) {
        pendingFocusInstruction = "use an example appropriate to sports that is not clinical exercise physiology related";
      } else {
        pendingFocusInstruction = "";
      }
    }

    function addUserMessage(content) {
        const div = document.createElement("div");
        div.className = "flex gap-4 flex-row-reverse animate-[fadeIn_0.3s_ease-out]";
        div.innerHTML = `
            <div class="space-y-1 max-w-[85%]">
                <div class="msg-user bg-[var(--color-primary)] text-white p-4 text-sm leading-relaxed shadow-lg">
                    ${formatMessage(content)}
                </div>
            </div>
        `;
        chatLog.appendChild(div);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function scrollMessageToTop(element) {
        const containerRect = chatLog.getBoundingClientRect();
        const elementRect = element.getBoundingClientRect();
        const offset = elementRect.top - containerRect.top + chatLog.scrollTop;
        chatLog.scrollTo({ top: offset, behavior: "smooth" });
    }

    function addBotMessage(content) {
        const div = document.createElement("div");
        div.className = "flex gap-4 animate-[slideIn_0.3s_ease-out]";
        div.innerHTML = `
             <img src="./ross pic.png"
                  class="w-10 h-10 rounded-full object-cover border border-slate-200 flex-none self-end mb-1"
                  alt="Ross Clark"
                  onerror="this.src='https://ui-avatars.com/api/?name=Ross+Clark&background=6366f1&color=fff'">
            <div class="space-y-1 max-w-[85%]">
                <div class="text-xs text-slate-500 ml-1">Ross Clark</div>
                <div class="msg-bot bg-white border border-slate-200 p-4 text-sm leading-relaxed shadow-sm text-slate-800" data-role="bot-content">
                    ${formatMessage(content)}
                </div>
            </div>
        `;
        chatLog.appendChild(div);
        const contentEl = div.querySelector("[data-role='bot-content']");
        scrollMessageToTop(contentEl);
        return contentEl;
    }

    function setTyping(isTyping) {
      if (isTyping) {
        typingIndicator.classList.remove("hidden");
        sendBtn.disabled = true;
        sendBtn.classList.add("opacity-50", "cursor-not-allowed");
        chatLog.appendChild(typingIndicator); 
        chatLog.scrollTop = chatLog.scrollHeight;
      } else {
        typingIndicator.classList.add("hidden");
        sendBtn.disabled = false;
        sendBtn.classList.remove("opacity-50", "cursor-not-allowed");
      }
    }

    // --- LOGIC RESTORATION ---

    function initMessages() {
      messages = [
        {
          role: "system",
          content: buildSystemPrompt(),
        },
      ];
    }
    
    // Initialise on load
    initMessages();

    // Set initial toggle appearance
    setToggleState(clinicalToggle, focusState.clinical);
    setToggleState(sportsToggle, focusState.sports);

    // Focus toggle interactions
    clinicalToggle.addEventListener("click", () => {
      focusState.clinical = !focusState.clinical;
      setToggleState(clinicalToggle, focusState.clinical);
      updatePendingFocusInstruction();
    });

    sportsToggle.addEventListener("click", () => {
      focusState.sports = !focusState.sports;
      setToggleState(sportsToggle, focusState.sports);
      updatePendingFocusInstruction();
    });

    // Crisis detection
    function looksLikeCrisis(text) {
      const lowered = text.toLowerCase();
      const keywords = ["kill myself", "suicide", "want to die", "end my life", "self harm", "self-harm", "hurt myself"];
      return keywords.some((k) => lowered.includes(k));
    }

    function crisisResponse() {
      return `I'm really glad you reached out — your safety is the most important thing.
      <br><br>
      I can't provide crisis counselling, but please consider these options right now:
      <br>• If you are in immediate danger call <strong>000</strong> (Australia).
      <br>• Contact <strong>Lifeline</strong> on <strong>13 11 14</strong>.
      <br>• If you are a student, please contact your university's student wellbeing team.
      <br><br>You do not have to go through this alone.`;
    }

    async function streamAssistantResponse() {
      const botContentEl = addBotMessage("");
      const decoder = new TextDecoder();
      let assistantContent = "";
      let buffer = "";
      let streamEnded = false;

      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages, stream: true }),
      });

      if (!response.ok) {
        const rawText = await response.text();
        let backendMsg = "The server returned an error.";
        try {
          const parsed = JSON.parse(rawText);
          if (parsed?.error) {
            backendMsg =
              typeof parsed.error === "string"
                ? parsed.error
                : parsed.error.message || backendMsg;
          }
        } catch (e) {
          // ignore
        }
        errorSpan.textContent = "Error: " + backendMsg;
        botContentEl.innerHTML = formatMessage("Sorry, I couldn't generate a response just now.");
        return assistantContent;
      }

      const reader = response.body?.getReader();
      if (!reader) {
        throw new Error("Readable stream not available");
      }

      while (!streamEnded) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });

        while (true) {
          const lineEnd = buffer.indexOf("\n");
          if (lineEnd === -1) break;

          const line = buffer.slice(0, lineEnd).trim();
          buffer = buffer.slice(lineEnd + 1);

          if (!line || line.startsWith(":")) continue;
          if (!line.startsWith("data: ")) continue;

          const dataStr = line.slice(6);
          if (dataStr === "[DONE]") {
            streamEnded = true;
            break;
          }

          try {
            const parsed = JSON.parse(dataStr);

            if (parsed?.error) {
              const msg =
                parsed.error?.message || "An error occurred during streaming.";
              errorSpan.textContent = "Error: " + msg;
              streamEnded = true;
              break;
            }

            const delta = parsed?.choices?.[0]?.delta?.content || "";
            if (delta) {
              assistantContent += delta;
              botContentEl.innerHTML = formatMessage(assistantContent);
            }

            const finishReason = parsed?.choices?.[0]?.finish_reason;
            if (finishReason === "stop" || finishReason === "length") {
              streamEnded = true;
              break;
            }
          } catch (err) {
            // Ignore malformed SSE payloads
          }
        }
      }

      return assistantContent;
    }

    // Form Submission
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      errorSpan.textContent = "";

      const userText = textarea.value.trim();
      if (!userText) return;

      const focusPrefix = pendingFocusInstruction ? `${pendingFocusInstruction}. ` : "";
      const messageToSend = `${focusPrefix}${userText}`.trim();
      pendingFocusInstruction = "";

      // 1. Add user message
      addUserMessage(userText);
      messages.push({ role: "user", content: messageToSend }); // Update history
      textarea.value = "";
      textarea.style.height = 'auto'; // Reset height
      
      setTyping(true);

      // 2. Local Crisis Check
      if (looksLikeCrisis(userText)) {
        setTimeout(() => {
            const supportText = crisisResponse();
            addBotMessage(supportText);
            messages.push({ role: "assistant", content: supportText });
            setTyping(false);
        }, 1000); 
        return;
      }

      // 3. Backend Call with streaming
      try {
        const assistantReply = await streamAssistantResponse();
        if (assistantReply) {
          messages.push({ role: "assistant", content: assistantReply });
        }
      } catch (err) {
        console.error(err);
        errorSpan.textContent = "Network error connecting to backend.";
      } finally {
        setTyping(false);
      }
    });

    // Handle Enter key
    textarea.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            form.dispatchEvent(new Event("submit"));
        }
    });

  </script>
</body>
</html>
