<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SPX102 Coach Ross</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <!-- Tailwind CSS for modern styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      font-family: 'Open Sans', sans-serif;
      --color-primary: #0052C4;
      --color-secondary: #fce726;
      --color-surface: #ffffff;
      --color-muted: #f8fafc;
      --color-border: #e2e8f0;
      --color-text: #0f172a;
      --color-subtle: #475569;
    }
    
    /* Custom Scrollbar */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    
    .custom-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scroll::-webkit-scrollbar-track {
      background: rgba(226, 232, 240, 0.8);
    }
    .custom-scroll::-webkit-scrollbar-thumb {
      background-color: #94a3b8;
      border-radius: 20px;
    }

    /* Message Bubbles */
    .msg-user {
      border-radius: 18px 18px 4px 18px;
    }
    .msg-bot {
      border-radius: 18px 18px 18px 4px;
    }

    .msg-user,
    .msg-bot,
    .rich-text {
      word-break: break-word;
      overflow-wrap: anywhere;
      hyphens: auto;
      max-width: 100%;
    }

    /* Bounce animation for dots */
    .typing-dot {
      animation: bounce 1.4s infinite ease-in-out both;
      background-color: #94a3b8; 
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin: 0 2px;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* Gradient Text */
    .text-gradient {
      background: linear-gradient(to right, #0052C4, #1a73e8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Rich text styling for bot replies */
    .rich-text {
      color: var(--color-text);
    }
    .rich-text h2,
    .rich-text h3,
    .rich-text h4 {
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--color-primary);
      margin-bottom: 0.35rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    .rich-text h2::before,
    .rich-text h3::before,
    .rich-text h4::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 9999px;
      background: linear-gradient(135deg, #0052C4, #1a73e8);
      box-shadow: 0 0 0 6px rgba(0, 82, 196, 0.08);
    }
    .rich-text p {
      margin-bottom: 0.75rem;
      line-height: 1.7;
    }
    .rich-text ul {
      list-style: none;
      padding-left: 0;
      margin: 0.5rem 0 1rem;
      display: grid;
      gap: 0.35rem;
    }
    .rich-text ul li {
      position: relative;
      padding-left: 1.2rem;
    }
    .rich-text ul li::before {
      content: "•";
      position: absolute;
      left: 0;
      top: 0;
      color: var(--color-primary);
      font-weight: 700;
    }
    .rich-text ol {
      counter-reset: item;
      padding-left: 0;
      margin: 0.5rem 0 1rem;
      display: grid;
      gap: 0.35rem;
    }
    .rich-text ol li {
      counter-increment: item;
      padding-left: 1.6rem;
      position: relative;
    }
    .rich-text ol li::before {
      content: counter(item) ".";
      position: absolute;
      left: 0;
      top: 0;
      color: var(--color-primary);
      font-weight: 700;
    }
    .rich-text hr {
      border: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(148, 163, 184, 0.4), transparent);
      margin: 1.5rem 0;
    }
    .rich-text table {
      width: 100%;
      max-width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 12px;
      overflow: hidden;
      background: #f8fafc;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .rich-text th,
    .rich-text td {
      padding: 0.65rem 0.9rem;
      text-align: left;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
    }
    .rich-text th {
      background: linear-gradient(90deg, rgba(0, 82, 196, 0.12), rgba(26, 115, 232, 0.08));
      color: #0f172a;
      font-weight: 700;
      letter-spacing: 0.01em;
      text-transform: uppercase;
      font-size: 0.75rem;
    }
    .rich-text tr:last-child td {
      border-bottom: none;
    }
    .rich-text strong {
      color: #0f172a;
      font-weight: 700;
    }
    .rich-text .card-block {
      background: linear-gradient(145deg, rgba(0, 82, 196, 0.06), rgba(240, 247, 255, 0.9));
      border: 1px solid rgba(0, 82, 196, 0.25);
      padding: 1rem;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0, 82, 196, 0.08);
      backdrop-filter: blur(6px);
      margin-bottom: 0.9rem;
    }
  </style>
</head>
<body class="bg-white text-slate-900 h-screen flex flex-col overflow-hidden selection:bg-[#0052C4] selection:text-white">

  <!-- Header -->
  <header class="flex-none bg-white backdrop-blur-md border-b border-slate-200 p-4 flex items-center gap-4 z-20 shadow-sm">
    <div class="relative group cursor-pointer">
      <div class="absolute -inset-0.5 bg-gradient-to-r from-[#0052C4] to-[#1a73e8] rounded-full blur opacity-40 group-hover:opacity-80 transition duration-500"></div>
      <img
        src="./ross pic.png"
        alt="Ross Clark"
        class="relative w-12 h-12 rounded-full object-cover border-2 border-white"
        onerror="this.src='https://ui-avatars.com/api/?name=Ross+Clark&background=6366f1&color=fff'"
      />
      <div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full animate-pulse"></div>
    </div>
    
    <div class="flex-1 min-w-0">
      <h1 class="text-lg font-semibold text-slate-900 truncate flex items-center gap-2">
        Dr. Ross Clark
        <span class="px-2 py-0.5 rounded-full bg-[#0052C4]/10 text-[#0052C4] text-xs font-medium border border-[#0052C4]/20">AI Coach</span>
      </h1>
      <p class="text-xs text-slate-500 truncate">SPX102 Introduction to Coaching • Always Online</p>
    </div>
    
    <!-- Info Button -->
    <button onclick="alert('I can only answer questions based on the SPX102 Notes.')" class="p-2 text-slate-500 hover:text-slate-900 transition-colors rounded-full hover:bg-slate-100">
      <i data-lucide="info" class="w-5 h-5"></i>
    </button>
  </header>

  <!-- Chat Log -->
  <main id="chat-log" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-6 scroll-smooth bg-white">

    <!-- Focus Toggles -->
    <section class="bg-slate-50 border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
      <p class="text-sm text-slate-700">Select none, one or both to make the chatbot focus on sports, clinical or sports-related clinical examples</p>
      <div class="flex flex-wrap gap-3">
        <button id="clinical-toggle" type="button" class="focus:outline-none relative overflow-hidden rounded-xl border border-slate-200 bg-white transition hover:-translate-y-0.5 hover:border-[#0052C4]/70 active:scale-[0.99] p-2 shadow-sm">
          <img src="./clinical.png" alt="Clinical focus" class="w-24 h-24 object-cover rounded-lg" />
          <span class="sr-only">Toggle clinical focus</span>
        </button>
        <button id="sports-toggle" type="button" class="focus:outline-none relative overflow-hidden rounded-xl border border-slate-200 bg-white transition hover:-translate-y-0.5 hover:border-[#0052C4]/70 active:scale-[0.99] p-2 shadow-sm">
          <img src="./sports.png" alt="Sports focus" class="w-24 h-24 object-cover rounded-lg" />
          <span class="sr-only">Toggle sports focus</span>
        </button>
      </div>
    </section>
    
    <!-- Welcome Message -->
    <div class="flex gap-4">
      <img src="./ross pic.png" class="w-10 h-10 rounded-full object-cover border border-slate-200 flex-none self-end mb-1" alt="Bot">
      <div class="space-y-1 max-w-[85%]">
        <div class="text-xs text-slate-500 ml-1">Ross Clark</div>
        <div class="msg-bot bg-white border border-slate-200 p-4 text-sm leading-relaxed shadow-sm text-slate-800">
          <p>Hello! I'm your AI assistant for <span class="text-[#0052C4] font-semibold">SPX102 INTRODUCTION TO COACHING</span>.</p>
          <br>
          <p>I can help you understand coaching pedagogy, training principles, or LTAD based on our course notes. What's on your mind?</p>
        </div>
      </div>
    </div>

  </main>

  <!-- Typing Indicator (Hidden by default) -->
  <div id="typing-indicator" class="hidden px-4 pb-2">
    <div class="flex gap-4">
      <img src="./ross pic.png" class="w-8 h-8 rounded-full object-cover border border-slate-200 flex-none self-end opacity-70" alt="Bot">
      <div class="msg-bot bg-slate-100 border border-slate-200 p-3 rounded-2xl rounded-bl-none w-16 flex items-center justify-center h-10">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>
  </div>

  <!-- Input Area -->
  <footer class="flex-none p-4 bg-white backdrop-blur-lg border-t border-slate-200">
    <form id="chat-form" class="max-w-4xl mx-auto relative flex items-end gap-2">
      
      <div class="relative flex-1 bg-slate-50 border border-slate-200 rounded-2xl focus-within:ring-2 focus-within:ring-[#0052C4]/40 focus-within:border-[#0052C4] focus-within:bg-white transition-all duration-300 shadow-sm">
        <textarea
          id="user-input"
          rows="1"
          class="w-full bg-transparent text-slate-900 placeholder-slate-400 px-4 py-3.5 outline-none resize-none overflow-hidden max-h-32 text-sm"
          placeholder="Ask a question about coaching..."
          oninput="this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'"></textarea>
      </div>

      <button 
        type="submit" 
        id="send-btn" 
        class="flex-none h-[50px] w-[50px] bg-[#0052C4] hover:bg-[#1a73e8] text-white rounded-full flex items-center justify-center shadow-lg shadow-blue-500/30 transition-all hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
        <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
      </button>

    </form>
    <div class="text-center mt-2">
       <span id="error" class="text-xs text-red-400 font-medium"></span>
       <span class="text-[10px] text-slate-500">I can only answer questions based on the SPX102 INTRODUCTION TO COACHING notes I was given.</span>
    </div>
  </footer>

  <script>
    // Initialize Icons
    lucide.createIcons();

    const API_URL = "/.netlify/functions/openrouter-chat"; // Original Backend URL
    const chatLog = document.getElementById("chat-log");
    const form = document.getElementById("chat-form");
    const textarea = document.getElementById("user-input");
    const errorSpan = document.getElementById("error");
    const sendBtn = document.getElementById("send-btn");
    const typingIndicator = document.getElementById("typing-indicator");
    const clinicalToggle = document.getElementById("clinical-toggle");
    const sportsToggle = document.getElementById("sports-toggle");

    // Full message history
    let messages = [];
    let focusState = { clinical: false, sports: false };
    let pendingFocusInstruction = "";

    // --- KNOWLEDGE BASE (Restored) ---
    const knowledgeBase = `
## Assessment Tasks

### Task 1A – Coaching Knowledge & Conduct Modules (Weight: 10%, Due: Friday Week 4)
- Complete 4 online modules:
  - Play by the Rules (PBTR): Safeguarding Children and Young People in Sport Induction; Harassment and Discrimination.
  - Australian Sport Learning Centre: Community Coaching – Essential Skills; Community Officiating – General Principles.
- Submission: Save certificates (or screenshots), combine into a single PDF or Word file, and upload to Canvas.
- Goal: Demonstrate understanding of core coaching knowledge and professional conduct.

### Task 1B – Design a 1-Hour Coaching Session Plan (Weight: 20%, Due: Friday Week 8)
- Design a structured 1-hour lesson plan for any sport, event, or clinical condition using the provided template.
- Choose any sport recognized by the Australian Sports Commission.
- Format: PDF (preferred) or Word.
- AI Policy: Generative AI is allowed if used critically and acknowledged with a written declaration.
- Note: Attend the Week 6 workshop for feedback.

### Task 2 – Physical Capacity Testing (Weight: 50%, Due: Friday Week 13)
- Weeks 8–12: Perform one field-based physical test per week in scheduled labs with you as the coach.
- Submission:
  1. Video: One video of your best performance implementing a test with fellow students.
  2. Written Report: Max 400-word reflection on your coaching performance using the provided template.
- Goal: Implement, record, and analyse a field-based fitness test.
- Note: If you cannot record in class during Weeks 8–12, contact the Course Coordinator by Week 8.

### Task 3 – Centrally-Scheduled Exam (Weight: 20%, Exam window: TBD)
- Duration: 2 hours, fully online, open book; must be completed in one sitting once started.
- Content: Multiple choice and short answer questions covering theoretical content from the entire semester.
- AI Policy: AI is allowed.
- Warning: Do not start after 3pm on the Wednesday closing day to allow the full 2-hour window.

---

## Weekly Course Content

### Week 1: The Role of the Coach and Official
- **Role of the Coach:** Enhance performance (physical, cognitive, psychological, emotional) through teaching, facilitating practice, and feedback.
- **Core Themes:** Specificity (training mimics sport), Individuality (adjust to needs/preferences), Inclusion.
- **Facilitation:** Modern coaches guide athletes to develop robust motor programs rather than relying on explicit instruction.
- **Learning Styles:** Visual (graphs/demos), auditory (listening), kinesthetic (feeling). Most athletes are multimodal.
- **Learning Process:** Instruction → Practice → Feedback → Learning Effect → Retention.
- **Effective Instruction:** Use short, simple keywords; avoid info overload (1–2 points at a time); avoid focusing on “what not to do”.
- **Demonstrations:** Must be correct and shown at normal speed first to reinforce timing.
- **Feedback:** Task Intrinsic (sensory info) vs. Augmented (coach-provided). Knowledge of Results (outcome) vs. Knowledge of Performance (how the result was achieved).
- **Officiating:** Roles include controlling the game, making quick decisions, and communicating. Types: Interactors (e.g., soccer referee), Monitors (e.g., gymnastics judge), Reactors (e.g., tennis line judge). Cognitive process: Stimulus → Perception → Categorization → Memory Access → Integration → Response.

### Week 2: Talent Identification and Performance Testing
- **Talent Identification (TID):** Finding individuals with promise for training.
- **Subtypes:** Talent Selection (athletes already in the sport); Talent Detection (recruit outside athletes based on transferable attributes such as anthropometry).
- **Draft Combines:** Physical testing batteries to identify key attributes for professional selection.
- **Reliability:** Consistency of a test under the same conditions.
- **Validity:** Accuracy of a test (measures what it intends to measure); a test can be reliable but not valid.
- **Kinanthropometry:** Measuring body segments, girths, and ratios to determine sport suitability. Includes bone growth, bone density (DEXA), and Peak Height Velocity (PHV) considerations for load management.

### Week 3: Training Principles
- **Super Compensation:** Plan sessions to hit the post-training adaptation peak.
- **Overload:** Modify training variables to increase workload.
- **FIT Principles:** Frequency, Intensity, Time (Duration), Type.
- **Core Principles:** Specificity, Individuality, Reversibility (“use it or lose it”).
- **Recovery:** Sleep and nutrition are fundamentals. Cold water immersion and compression can aid jump performance and strength recovery.

### Week 4: Training Capacities
- **Endurance:** Minimize speed loss over time; train via intervals, repeat sprints, or small-sided games (larger pitches increase endurance demand).
- **Strength:** Maximal force production. Types: Maximal, Strength Endurance, Relative, Absolute. Training targets: Hypertrophy (6–12 reps), Strength (1–6 reps), Power (1–5 reps at velocity), Endurance (12–20+ reps).
- **Speed:** Stride Length × Stride Frequency; train via plyometrics (rate of force development) and intervals.
- **Flexibility:** ROM around a joint; influenced by age, gender, temperature.
- **Skill & Concurrent Training:** Skill combines technique and decision-making; concurrent training guidance—Strength + Speed can be same day (4–6 hours apart); avoid combining Endurance + Hypertrophy in the same cycle.

### Week 5: Training, Planning, and Programming
- **Planning Cycles:** Quadrennial (4-year, mono/bi-cycle), Macrocycle (1 year), Mesocycle (4–6 weeks), Microcycle (weekly).
- **Periodisation Phases:** General Preparatory → Specific Preparatory → Pre-Competition → Competition → Transition.
- **Tapering:** Reduce volume while maintaining intensity to let adaptations emerge.

### Week 6: Session Modification and Games-Based Learning
- **Dynamic Systems Theory:** Skills emerge from Task, Performer, and Environment constraints; self-organization adjusts movement solutions.
- **Modification Frameworks:** TREE (Teaching style, Rules, Environment, Equipment), CHANGE IT (Coaching style, How to score, Area, Numbers, Game rules, Equipment, Inclusion, Time), TGfU (Teaching Games for Understanding) combines skills and tactics in modified games.
- **Warm-Ups & Technique:** Warm-up goals—raise temperature, prepare decision-making, mobilize joints. Evidence: Dynamic warm-ups improve performance (~7–8%); static stretching reduces strength (~30%) if done immediately before. No single “perfect” technique; only modify for injury prevention or performance.

### Week 7: LTAD Framework
- **Stages:** Active Start (0–6), FUNdamentals (6–9/10), Learn to Train (8–11/9–12), Train to Train (11–15/12–16), Train to Compete (15–21+), Train to Win (18+), Active for Life.

### Week 8: LTAD (Learn to Train & Train to Train)
- **Learn to Train:** Focus on sport-specific skills and coordination (fine motor window). Structure: 70% Training / 30% Competition; multisport participation encouraged.
- **Train to Train:** Focus on “building the engine” (aerobic/strength); puberty and PHV occur here. Structure: 60% Training / 40% Competition. Cognitive development enables strategy and complex drills.
- **Youth Issues:** Overuse injuries (Osgood-Schlatter, Sever’s Disease, Scheuermann’s). Thermoregulation: children gain heat faster and sweat less—mandatory drink breaks every 15–20 minutes.

### Week 9: LTAD (Later Stages)
- **Train to Compete:** Optimize strength, power, and position-specific skills; specialize in 1–2 sports. Structure: 40% Training / 60% Competition. Phases: Initial Specialization (growth + training) and Final Specialization (training only).
- **Train to Win:** Focus on winning and high performance; athletes are autonomous. Structure: 25% Training / 75% Competition. 2% rule: athletes within 2% of PB before competition are likely to peak.
- **Active for Life:** Streams include Competitive for Life (Masters), Fit for Life, and Sport Leaders (Coaches/Admin) to address obesity and maintain health.

### Week 10: Coaching Female Athletes
- **Physiology & Classification:** Testosterone drives muscle/aerobic capacity (males 10–35 nmol/L; females 0.35–2.0 nmol/L). IOC policy (2021) uses sport-specific regulations.
- **Injury Risk:** Females are 2–8x more likely to have non-contact ACL injuries. Wider pelvis increases Q-angle leading to knee valgus; strengthen hamstrings/glutes and teach proper landing.
- **Menstrual Cycle:** Luteal phase increases core temperature (heat risk) and relaxin increases ligament laxity. Female Athlete Triad: Low Energy Availability → Menstrual Dysfunction (Amenorrhea) → Low Bone Mineral Density (Osteoporosis); amenorrhea is linked to stress fractures.

### Week 11: Coaching Diverse Populations
- **Ageing Athletes:** VO2 max drops ~30–40%; sarcopenia affects Type II fibers most. Osteoporosis risk increases—effective training requires high-impact or resistance work (swimming/cycling ineffective for bone density). ESSA screening is mandatory due to cardiac risk.
- **Athletes with Disability:** Do not change fundamentals—use TREE to modify constraints. Spinal Cord Injury: impaired sweating below lesion (overheating risk) and autonomic dysreflexia (dangerous BP spikes from painful stimuli). Cerebral Palsy: spasticity from hyperactive stretch reflex—stretching is a priority. Amputees: monitor skin care in prosthesis and thermoregulation (less surface area to cool).

### Week 12: Future Trends in Sport
- **Data Analytics:** Descriptive (what happened), Diagnostic (why), Predictive (what will happen), Prescriptive (how to make it happen). Example: Brentford FC used “Hops” metrics to exploit long-ball tactics against high-pressing teams.
- **AI & Technology:** Officiating uses semi-automated offside (ball sensors and limb tracking). Training apps automate programming but still need human oversight for context (e.g., sleep quality vs. HRV). Super shoes (carbon plate + foam) improve running economy ~4% (~2% faster), so coaches may adjust HR zones because HR can be lower at the same speed.
    `.trim();

    // --- SYSTEM PROMPT BUILDER (Restored) ---
    function buildSystemPrompt() {
      return `
Your role:
- You are the SPX102 INTRODUCTION TO COACHING course chatbot. Answer only from the provided notes.

You MUST follow these rules exactly:

1. PRIORITISE SAFETY OF THE USER
   - If the user appears to be in immediate danger, at risk of harming themselves, or describes serious harm from others:
     - Do NOT provide clinical advice.
     - Encourage them to seek urgent help.
     - Provide specific contacts such as:
       - Emergency services (e.g., call 000 in Australia).
       - National mental health helplines (e.g., Lifeline 13 11 14 in Australia).
       - Campus security and student support services (the teaching team will configure these for you).
   - Be warm, supportive, and non-judgemental.

2. ABSOLUTE SAFETY RESTRICTIONS
   - You must NEVER:
     - Provide instructions, methods, or encouragement for self-harm or suicide.
     - Provide guidance on illegal drugs, their manufacture, or their unsafe use.
     - Provide instructions for violence, weapons, or harming others.
   - If asked, clearly refuse and, where appropriate, gently steer the conversation to safety and wellbeing or back to course-related content.

3. STYLE
   - Use clear, concise explanations.
   - When explaining difficult concepts, use simple examples aimed at university educators.
   - When describing workflows, display the steps as a vertical list with emoji bullet points. Use bold headers for the action on each bullet, followed by details. Put "Tools" and "Why" on separate lines under the header.

KNOWLEDGE BASE (sole source of truth):
${knowledgeBase}
      `.trim();
    }

    // --- UI HELPER FUNCTIONS ---
    
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function applyInlineFormatting(text) {
      const cleaned = text
        .replace(/<br\s*\/?>/gi, " ")
        .replace(/\u00a0|&nbsp;/gi, " ")
        .replace(/\s{2,}/g, " ");
      const escaped = escapeHtml(cleaned);
      const bolded = escaped.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
      return bolded.replace(/_(.*?)_/g, "<em>$1</em>");
    }

    function renderTable(lines, startIndex) {
      const rows = [];
      let i = startIndex;
      while (i < lines.length && lines[i].trim().startsWith("|")) {
        const row = lines[i]
          .trim()
          .replace(/^\||\|$/g, "")
          .split("|")
          .map((cell) => applyInlineFormatting(cell.trim()));
        rows.push(row);
        i++;
      }

      let header = [];
      let body = rows;

      if (rows.length > 1 && rows[1].every((cell) => /^-+$/.test(cell.replace(/<.*?>/g, "")))) {
        header = rows[0];
        body = rows.slice(2);
      }

      const headerHtml = header.length
        ? `<thead><tr>${header.map((cell) => `<th>${cell}</th>`).join("")}</tr></thead>`
        : "";
      const bodyHtml = body
        .map((row) => `<tr>${row.map((cell) => `<td>${cell}</td>`).join("")}</tr>`)
        .join("");

      return { html: `<table class="rich-text-table">${headerHtml}<tbody>${bodyHtml}</tbody></table>`, nextIndex: i - 1 };
    }

    function formatMessage(content) {
      const lines = content.trim().split("\n");
      let html = '<div class="rich-text space-y-2">';
      let inUl = false;
      let inOl = false;

      const closeLists = () => {
        if (inUl) {
          html += "</ul>";
          inUl = false;
        }
        if (inOl) {
          html += "</ol>";
          inOl = false;
        }
      };

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) {
          closeLists();
          continue;
        }

        // Tables
        if (line.startsWith("|")) {
          closeLists();
          const { html: tableHtml, nextIndex } = renderTable(lines, i);
          html += tableHtml;
          i = nextIndex;
          continue;
        }

        // Headings
        if (/^#{1,6}\s+/.test(line)) {
          closeLists();
          const level = line.match(/^#+/)[0].length;
          const text = applyInlineFormatting(line.replace(/^#{1,6}\s+/, ""));
          html += `<h${Math.min(level + 1, 4)}>${text}</h${Math.min(level + 1, 4)}>`;
          continue;
        }

        // Divider
        if (/^(-\s*){3,}$/.test(line)) {
          closeLists();
          html += "<hr/>";
          continue;
        }

        // Ordered List
        const orderedMatch = line.match(/^\d+\.\s+(.*)/);
        if (orderedMatch) {
          if (!inOl) {
            closeLists();
            inOl = true;
            html += '<ol class="pl-4">';
          }
          html += `<li>${applyInlineFormatting(orderedMatch[1])}</li>`;
          continue;
        }

        // Unordered List
        const unorderedMatch = line.match(/^[-*]\s+(.*)/);
        if (unorderedMatch) {
          if (!inUl) {
            closeLists();
            inUl = true;
            html += '<ul class="pl-4">';
          }
          html += `<li>${applyInlineFormatting(unorderedMatch[1])}</li>`;
          continue;
        }

        // Paragraph / Card block
        closeLists();
        const paragraph = applyInlineFormatting(line);
        const isEmphasized = paragraph.startsWith("<strong>") || paragraph.toLowerCase().startsWith("note:");
        html += `<div class="${isEmphasized ? "card-block" : ""}"><p>${paragraph}</p></div>`;
      }

      closeLists();
      html += "</div>";
      return html;
    }

    function setToggleState(button, isActive) {
      button.setAttribute("aria-pressed", isActive);
      const highlightClasses = [
        "ring-4",
        "ring-offset-2",
        "ring-offset-white",
        "ring-[var(--color-secondary)]",
        "border-[var(--color-secondary)]",
        "bg-[var(--color-secondary)]/20",
        "shadow-lg",
        "shadow-yellow-200/80",
      ];

      highlightClasses.forEach((cls) => button.classList.toggle(cls, isActive));
    }

    function updatePendingFocusInstruction() {
      const { clinical, sports } = focusState;
      if (clinical && sports) {
        pendingFocusInstruction = "use examples specific to sports related clinical exercise physiology";
      } else if (clinical) {
        pendingFocusInstruction = "use an example appropriate to clinical exercise physiology that is not sports related";
      } else if (sports) {
        pendingFocusInstruction = "use an example appropriate to sports that is not clinical exercise physiology related";
      } else {
        pendingFocusInstruction = "";
      }
    }

    function addUserMessage(content) {
        const div = document.createElement("div");
        div.className = "flex gap-4 flex-row-reverse animate-[fadeIn_0.3s_ease-out]";
        div.innerHTML = `
            <div class="space-y-1 max-w-[85%]">
                <div class="msg-user bg-[var(--color-secondary)] text-black p-4 text-sm leading-relaxed shadow-lg">
                    ${formatMessage(content)}
                </div>
            </div>
        `;
        chatLog.appendChild(div);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function scrollMessageToTop(element) {
        const containerRect = chatLog.getBoundingClientRect();
        const elementRect = element.getBoundingClientRect();
        const offset = elementRect.top - containerRect.top + chatLog.scrollTop;
        chatLog.scrollTo({ top: offset, behavior: "smooth" });
    }

    function addBotMessage(content) {
        const div = document.createElement("div");
        div.className = "flex gap-4 animate-[slideIn_0.3s_ease-out]";
        div.innerHTML = `
             <img src="./ross pic.png"
                  class="w-10 h-10 rounded-full object-cover border border-slate-200 flex-none self-end mb-1"
                  alt="Ross Clark"
                  onerror="this.src='https://ui-avatars.com/api/?name=Ross+Clark&background=6366f1&color=fff'">
            <div class="space-y-1 max-w-[85%]">
                <div class="text-xs text-slate-500 ml-1">Ross Clark</div>
                <div class="msg-bot bg-white border border-slate-200 p-4 text-sm leading-relaxed shadow-sm text-slate-800" data-role="bot-content">
                    ${formatMessage(content)}
                </div>
            </div>
        `;
        chatLog.appendChild(div);
        const contentEl = div.querySelector("[data-role='bot-content']");
        scrollMessageToTop(contentEl);
        return contentEl;
    }

    function setTyping(isTyping) {
      if (isTyping) {
        typingIndicator.classList.remove("hidden");
        sendBtn.disabled = true;
        sendBtn.classList.add("opacity-50", "cursor-not-allowed");
        chatLog.appendChild(typingIndicator); 
        chatLog.scrollTop = chatLog.scrollHeight;
      } else {
        typingIndicator.classList.add("hidden");
        sendBtn.disabled = false;
        sendBtn.classList.remove("opacity-50", "cursor-not-allowed");
      }
    }

    // --- LOGIC RESTORATION ---

    function initMessages() {
      messages = [
        {
          role: "system",
          content: buildSystemPrompt(),
        },
      ];
    }
    
    // Initialise on load
    initMessages();

    // Set initial toggle appearance
    setToggleState(clinicalToggle, focusState.clinical);
    setToggleState(sportsToggle, focusState.sports);

    // Focus toggle interactions
    clinicalToggle.addEventListener("click", () => {
      focusState.clinical = !focusState.clinical;
      setToggleState(clinicalToggle, focusState.clinical);
      updatePendingFocusInstruction();
    });

    sportsToggle.addEventListener("click", () => {
      focusState.sports = !focusState.sports;
      setToggleState(sportsToggle, focusState.sports);
      updatePendingFocusInstruction();
    });

    // Crisis detection
    function looksLikeCrisis(text) {
      const lowered = text.toLowerCase();
      const keywords = ["kill myself", "suicide", "want to die", "end my life", "self harm", "self-harm", "hurt myself"];
      return keywords.some((k) => lowered.includes(k));
    }

    function crisisResponse() {
      return `I'm really glad you reached out — your safety is the most important thing.
      <br><br>
      I can't provide crisis counselling, but please consider these options right now:
      <br>• If you are in immediate danger call <strong>000</strong> (Australia).
      <br>• Contact <strong>Lifeline</strong> on <strong>13 11 14</strong>.
      <br>• If you are a student, please contact your university's student wellbeing team.
      <br><br>You do not have to go through this alone.`;
    }

    async function streamAssistantResponse() {
      const botContentEl = addBotMessage("");
      const decoder = new TextDecoder();
      let assistantContent = "";
      let buffer = "";
      let streamEnded = false;

      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages, stream: true }),
      });

      if (!response.ok) {
        const rawText = await response.text();
        let backendMsg = "The server returned an error.";
        try {
          const parsed = JSON.parse(rawText);
          if (parsed?.error) {
            backendMsg =
              typeof parsed.error === "string"
                ? parsed.error
                : parsed.error.message || backendMsg;
          }
        } catch (e) {
          // ignore
        }
        errorSpan.textContent = "Error: " + backendMsg;
        botContentEl.innerHTML = formatMessage("Sorry, I couldn't generate a response just now.");
        return assistantContent;
      }

      const reader = response.body?.getReader();
      if (!reader) {
        throw new Error("Readable stream not available");
      }

      while (!streamEnded) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });

        while (true) {
          const lineEnd = buffer.indexOf("\n");
          if (lineEnd === -1) break;

          const line = buffer.slice(0, lineEnd).trim();
          buffer = buffer.slice(lineEnd + 1);

          if (!line || line.startsWith(":")) continue;
          if (!line.startsWith("data: ")) continue;

          const dataStr = line.slice(6);
          if (dataStr === "[DONE]") {
            streamEnded = true;
            break;
          }

          try {
            const parsed = JSON.parse(dataStr);

            if (parsed?.error) {
              const msg =
                parsed.error?.message || "An error occurred during streaming.";
              errorSpan.textContent = "Error: " + msg;
              streamEnded = true;
              break;
            }

            const delta = parsed?.choices?.[0]?.delta?.content || "";
            if (delta) {
              assistantContent += delta;
              botContentEl.innerHTML = formatMessage(assistantContent);
            }

            const finishReason = parsed?.choices?.[0]?.finish_reason;
            if (finishReason === "stop" || finishReason === "length") {
              streamEnded = true;
              break;
            }
          } catch (err) {
            // Ignore malformed SSE payloads
          }
        }
      }

      return assistantContent;
    }

    // Form Submission
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      errorSpan.textContent = "";

      const userText = textarea.value.trim();
      if (!userText) return;

      const focusPrefix = pendingFocusInstruction ? `${pendingFocusInstruction}. ` : "";
      const messageToSend = `${focusPrefix}${userText}`.trim();
      pendingFocusInstruction = "";

      // 1. Add user message
      addUserMessage(userText);
      messages.push({ role: "user", content: messageToSend }); // Update history
      textarea.value = "";
      textarea.style.height = 'auto'; // Reset height
      
      setTyping(true);

      // 2. Local Crisis Check
      if (looksLikeCrisis(userText)) {
        setTimeout(() => {
            const supportText = crisisResponse();
            addBotMessage(supportText);
            messages.push({ role: "assistant", content: supportText });
            setTyping(false);
        }, 1000); 
        return;
      }

      // 3. Backend Call with streaming
      try {
        const assistantReply = await streamAssistantResponse();
        if (assistantReply) {
          messages.push({ role: "assistant", content: assistantReply });
        }
      } catch (err) {
        console.error(err);
        errorSpan.textContent = "Network error connecting to backend.";
      } finally {
        setTyping(false);
      }
    });

    // Handle Enter key
    textarea.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            form.dispatchEvent(new Event("submit"));
        }
    });

  </script>
</body>
</html>
